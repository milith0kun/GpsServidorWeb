# Configuración Apache para Servidor Web GPS
# Optimizado para Ubuntu 20.04+ con Apache 2.x

# Habilitar reescritura de URLs
RewriteEngine On

# Configuración de seguridad
# Prevenir acceso a archivos sensibles
<Files ".htaccess">
    Require all denied
</Files>

<Files "*.log">
    Require all denied
</Files>

<Files "config.php">
    Require all denied
</Files>

# Configuración CORS para APIs
<IfModule mod_headers.c>
    # Permitir CORS para endpoints API
    <FilesMatch "\.(php)$">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
        Header always set Access-Control-Max-Age "3600"
    </FilesMatch>
    
    # Configuración de cache para archivos estáticos
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    # Configuración de cache para archivos HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "max-age=3600, public"
    </FilesMatch>
    
    # No cache para archivos PHP (APIs)
    <FilesMatch "\.(php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Configuración de compresión
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Configuración de tipos MIME
<IfModule mod_mime.c>
    AddType application/json .json
    AddType text/css .css
    AddType application/javascript .js
</IfModule>

# Redirecciones para URLs amigables
# Redirigir /api/posicion_ultima.json a /api/posicion_ultima.json.php
RewriteRule ^api/posicion_ultima\.json$ api/posicion_ultima.json.php [L]

# Página de inicio por defecto
DirectoryIndex index.html index.php

# Configuración de errores personalizados
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# Configuración de seguridad adicional
# Prevenir ataques de inyección
<IfModule mod_rewrite.c>
    # Bloquear intentos de inyección SQL
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# Limitar tamaño de subida para APIs
<IfModule mod_php7.c>
    php_value upload_max_filesize 1M
    php_value post_max_size 2M
    php_value max_execution_time 30
    php_value max_input_time 30
</IfModule>

<IfModule mod_php8.c>
    php_value upload_max_filesize 1M
    php_value post_max_size 2M
    php_value max_execution_time 30
    php_value max_input_time 30
</IfModule>

# Configuración para desarrollo local
# Mostrar errores PHP solo en desarrollo
<IfModule mod_env.c>
    SetEnv ENVIRONMENT development
</IfModule>

# Configuración de logs
<IfModule mod_log_config.c>
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
    CustomLog logs/access.log combined
</IfModule>